<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2022 개정 교육과정 암기 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #121212;
            color: white;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        .font-jua { font-family: 'Jua', sans-serif; }

        /* --- 입력창 및 관련 스타일 --- */
        .input-wrapper { display: inline-block; position: relative; vertical-align: bottom; margin: 0 0.25rem; }
        .quiz-input {
            background: transparent; border: none; border-bottom: 2px solid #4B5563;
            color: #E5E7EB; text-align: center; font-size: 1em; line-height: 1.5;
            padding: 4px 8px; min-width: 80px; transition: all 0.3s ease;
        }
        .quiz-input:focus { outline: none; border-bottom: 2px solid #42A5F5; }
        .quiz-input.correct { border-bottom: 2px solid #66BB6A; color: #66BB6A; }
        .quiz-input.incorrect-1 { border-bottom: 2px solid #F97316; }
        .quiz-input.incorrect-2 { border-bottom: 2px solid #EF5350; color: #EF5350; }
        
        #question-container { color: #E5E7EB; line-height: 2; text-align: left; }

        /* --- 애니메이션 및 효과 --- */
        @keyframes wobble { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        .wobble { animation: wobble 0.3s ease-in-out; }
        
        @keyframes score-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-30px) scale(1.5); opacity: 0; } }
        .score-up-animation { position: absolute; font-weight: bold; animation: score-up 0.8s ease-out; pointer-events: none; }

        @keyframes perfect-pop { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes perfect-fade-out { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .perfect-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Jua', sans-serif; font-size: 4rem; color: #42A5F5;
            text-shadow: 0 0 10px #000; pointer-events: none;
            animation: perfect-pop 0.5s ease-out forwards;
        }
        .perfect-message.fade-out { animation: perfect-fade-out 0.5s ease-in forwards; }


        /* (Plant visuals removed) */
/* --- Celebration Effects --- */
        .confetti { position: fixed; top: -10px; width: 8px; height: 8px; pointer-events: none; z-index: 100; }
        @keyframes screen-shake { 0%,100% { transform: translate(0,0); } 20%,60% { transform: translate(-5px,5px); } 40%,80% { transform: translate(5px,-5px); } }
        .shake { animation: screen-shake 0.5s; }

        
        /* --- 지식 지도 & 오답 노트 --- */
        .map-section, .incorrect-note-section {
            width: 100%;
            max-width: 800px;
            margin-top: 1rem;
            margin-left: auto;
            margin-right: auto;
        }
        .map-title {
            font-family: 'Jua', sans-serif;
            font-size: 1.5rem;
            color: #9ca3af;
            border-bottom: 2px solid #4b5563;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }
        #knowledge-map { display: flex; flex-direction: column; align-items: center; }
        .star-container {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .star-container:hover { transform: scale(1.1); }
        .knowledge-icon-svg {
            width: 3rem;
            height: 3rem;
            transition: all 0.3s;
        }
        .knowledge-icon-svg.unlocked path { fill: #6b7280; }
        .knowledge-icon-svg.completed path { fill: #3b82f6; filter: drop-shadow(0 0 6px #3b82f6); }
        .knowledge-icon-svg.perfect path { fill: #facc15; filter: drop-shadow(0 0 10px #facc15); }

        .star-label { font-size: 0.8rem; text-align: center; margin-top: 0.5rem; color: #d1d5db; word-break: keep-all; }
        
        .incorrect-item {
            background-color: #2d2d2d;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #ef5350;
        }
        .incorrect-item-category {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
        .incorrect-item-question {
            color: #e5e7eb;
        }

        /* --- 모드 선택 버튼 --- */
        .mode-btn {
            background-color: #4b5563;
            transition: background-color 0.2s, transform 0.2s;
        }
        .mode-btn:disabled {
            background-color: #374151;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .mode-btn.selected {
            background-color: #42A5F5;
            color: #121212;
            transform: scale(1.05);
        }

        /* --- 룰렛 스타일 --- */
        #roulette-screen {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }
        #slot-machine {
            position: relative;
            background: linear-gradient(to bottom, #333, #111);
            border-radius: 20px;
            border: 5px solid #555;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7), 0 0 20px rgba(255,215,0,0.5);
            padding: 2rem;
        }
        .reels-container {
            display: flex;
            justify-content: center;
            background: #222;
            border: 3px solid #111;
            border-radius: 10px;
            padding: 1rem;
            overflow: hidden;
            position: relative;
        }
        .reels-container::before, .reels-container::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, rgba(34,34,34,1) 0%, rgba(34,34,34,0) 100%);
            z-index: 5;
        }
        .reels-container::before {
            top: 0;
        }
        .reels-container::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(34,34,34,1) 0%, rgba(34,34,34,0) 100%);
        }
        .reel {
            width: 250px;
            height: 120px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
         .reel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -10px;
            right: -10px;
            height: 4px;
            background: #ffcc00;
            transform: translateY(-50%);
            box-shadow: 0 0 10px #ffcc00;
            z-index: 10;
        }
        .reel-strip {
            transition: transform 1.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .reel-item {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Jua', sans-serif;
            font-size: 2.25rem; /* 36px */
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            width: 100%;
            flex-shrink: 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .reel-item.active {
            transform: scale(1.15);
            box-shadow: 0 0 25px gold, inset 0 0 10px rgba(255,255,255,0.5);
            z-index: 10;
        }

        @keyframes flash {
            0%, 100% { box-shadow: 0 0 20px 10px rgba(255, 223, 0, 0.7); }
            50% { box-shadow: 0 0 30px 15px rgba(255, 255, 255, 1); }
        }
        #spin-btn.can-spin {
            animation: flash 1.5s infinite;
        }
        
        #review-toast {
            transition: opacity 0.5s, transform 0.5s;
        }

        @keyframes jackpot-flash {
            0% { background-color: rgba(255, 215, 0, 0); }
            50% { background-color: rgba(255, 215, 0, 0.7); }
            100% { background-color: rgba(255, 215, 0, 0); }
        }
        .jackpot-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: jackpot-flash 0.2s 5;
            z-index: 100;
            pointer-events: none;
        }
        .jackpot-text {
            font-family: 'Jua', sans-serif;
            font-size: 10rem;
            color: gold;
            text-shadow: 0 0 20px white, 0 0 40px #ffc107;
            animation: perfect-pop 1s ease-out;
        }
    </style>
</head>
<body class="w-screen h-screen flex flex-col items-center justify-center p-4 sm:p-8 overflow-y-auto">
    
    <!-- 로딩 오버레이 -->
    <div id="loading-screen" class="absolute inset-0 bg-black/90 flex flex-col justify-center items-center z-50">
        <div class="font-jua text-3xl text-white animate-pulse">로딩 중...</div>
    </div>

    <!-- 상단 UI: 자산, 진행도 -->
    <div id="game-ui" class="w-full max-w-6xl absolute top-0 left-1/2 -translate-x-1/2 p-4 sm:p-6 hidden">
        <div class="flex justify-between items-center gap-4 sm:gap-8 relative">
            <button id="home-btn" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-white/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
            </button>
            <div class="font-jua text-2xl sm:text-3xl text-yellow-400 min-w-[150px] text-center flex-1">자산: <span id="money">0원</span></div>
            <div class="flex-grow h-4 bg-[#2d2d2d] rounded-full overflow-hidden border border-gray-500">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-400 to-green-400 transition-all duration-500" style="width: 0%;"></div>
            </div>
            <div class="font-jua text-xl sm:text-2xl min-w-[80px] text-right"><span id="current-q">0</span> / <span id="total-q"></span></div>
        </div>
    </div>

    <!-- 퀴즈 박스 -->
    <div id="quiz-box" class="w-full max-w-6xl bg-[#2d2d2d]/80 backdrop-blur-sm border border-white/50 rounded-2xl shadow-2xl p-8 sm:p-12 hidden relative">
        <div id="category-display" class="text-left font-jua text-xl text-cyan-400 mb-4 pb-2 border-b-2 border-cyan-400/50"></div>
        <div id="question-container" class="min-h-[100px] sm:min-h-[140px]"></div>
        <button id="next-btn" class="font-jua text-xl sm:text-2xl bg-[#42A5F5] text-black px-8 py-3 rounded-full mt-8 transition-all duration-200 hover:scale-110 active:scale-95 hidden">Enter</button>
    </div>



    <!-- 시작/완료/오답노트 오버레이 -->
    <div id="start-screen" class="absolute inset-0 bg-black/80 flex flex-col justify-center items-center z-10 text-center p-4 overflow-y-auto">
        <div class="w-full max-w-6xl">
            <!-- Step 1: Mode Selection -->
            <div id="step-1-mode-selection">
                <h1 class="font-jua text-5xl sm:text-7xl mb-2">2022 개정 교육과정</h1>
                <p class="font-jua text-3xl sm:text-5xl mb-8 text-blue-400">학습 모드 선택</p>
                <div class="flex justify-center items-center flex-wrap gap-4">
                    <button id="select-mode-sequential" class="mode-btn font-jua text-3xl px-10 py-4 rounded-full" data-mode="sequential">순서대로</button>
                    <button id="select-mode-random" class="mode-btn font-jua text-3xl px-10 py-4 rounded-full" data-mode="random">랜덤으로</button>
                    <button id="select-mode-incorrect" class="mode-btn font-jua text-3xl px-10 py-4 rounded-full" data-mode="incorrect">오답노트</button>
                </div>
            </div>

            <!-- Step 2: Scope Selection -->
            <div id="step-2-scope-selection" class="hidden">
                 <button id="back-to-mode-selection" class="absolute top-4 left-4 font-jua text-xl bg-gray-600 px-4 py-2 rounded-full">&lt; 뒤로</button>
                <!-- Sequential Mode UI -->
                <div id="sequential-mode-ui" class="hidden">
                    <h1 class="font-jua text-4xl sm:text-6xl mb-4">지식의 별을 밝혀라!</h1>
                    <div id="knowledge-map">
                        <div class="map-section">
                            <h2 class="map-title">총론</h2>
                            <div id="chongron-map" class="map-grid"></div>
                        </div>
                        <div class="map-section">
                            <h2 class="map-title">창의적 체험활동</h2>
                            <div id="changche-map" class="map-grid"></div>
                        </div>
                    </div>
                </div>
                <!-- Random Mode UI -->
                <div id="random-mode-ui" class="hidden">
                    <h1 class="font-jua text-4xl sm:text-6xl mb-4">학습 범위 선택</h1>
                     <div class="mt-6 w-full max-w-sm mx-auto">
                        <select id="category-select" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-500 text-white text-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <!-- 옵션은 JS로 채워집니다 -->
                        </select>
                    </div>
                    <button id="start-btn" class="font-jua text-3xl sm:text-4xl bg-[#42A5F5] text-black px-12 py-4 mt-8 rounded-full transition-transform duration-200 hover:scale-110 active:scale-95">학습 시작!</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="incorrect-note-screen" class="absolute inset-0 bg-black/80 hidden flex-col justify-center items-center z-10 text-center p-4">
        <div class="w-full max-w-6xl h-full flex flex-col">
            <button id="back-to-main-from-incorrect" class="absolute top-4 left-4 font-jua text-xl bg-gray-600 px-4 py-2 rounded-full">&lt; 뒤로</button>
            <h1 class="font-jua text-4xl sm:text-6xl my-8">오답 노트</h1>
            <div id="incorrect-list-container" class="flex-grow bg-black/30 rounded-lg p-4 overflow-y-auto mb-4">
                <!-- 오답 목록이 여기에 채워집니다. -->
            </div>
            <div class="flex justify-center gap-4">
                 <button id="start-incorrect-quiz-btn" class="font-jua text-2xl bg-blue-500 text-white px-8 py-3 rounded-full hover:bg-blue-600 transition-colors">오답 다시 풀기</button>
                 <button id="clear-incorrect-notes-btn" class="font-jua text-2xl bg-red-600 text-white px-8 py-3 rounded-full hover:bg-red-700 transition-colors">전체 삭제</button>
            </div>
        </div>
    </div>

    <div id="end-screen" class="absolute inset-0 bg-black/80 hidden items-center justify-center z-10">
        <div class="text-center p-4">
            <h2 class="font-jua text-4xl sm:text-6xl mb-4">학습 완료!</h2>
            <p class="font-jua text-3xl sm:text-5xl mb-2">최종 자산: <span id="final-money" class="text-yellow-400">0원</span></p>
            <div class="flex gap-4 mt-8">
                <button id="retry-btn" class="font-jua text-2xl sm:text-3xl bg-[#42A5F5] text-black px-10 py-4 rounded-full transition-transform duration-200 hover:scale-110 active:scale-95">다시 하기</button>
                <button id="main-menu-btn" class="font-jua text-2xl sm:text-3xl bg-gray-500 text-white px-10 py-4 rounded-full transition-transform duration-200 hover:scale-110 active:scale-95">메인으로</button>
            </div>
        </div>
    </div>

    <!-- 룰렛 오버레이 -->
    <div id="roulette-screen" class="absolute inset-0 justify-center items-center z-40 hidden">
        <div class="flex flex-col items-center gap-8">
            <h2 class="font-jua text-6xl text-yellow-300 text-center" style="text-shadow: 0 0 15px #facc15;">- CHANCE TIME -</h2>
            <div id="slot-machine">
                <div class="reels-container">
                    <div class="reel"><div class="reel-strip" id="reel1"></div></div>
                </div>
            </div>
            <button id="spin-btn" class="font-jua text-4xl bg-yellow-400 text-black px-12 py-4 rounded-full transition-transform duration-200 hover:scale-110 active:scale-95 shadow-lg">SPIN!</button>
            <div id="roulette-result" class="font-jua text-4xl text-white h-12"></div>
        </div>
    </div>

    <div id="review-toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-10 transition-all duration-300">
        오늘 복습할 문항이 없습니다!
    </div>

    <script>
        // =================================================================
        // --- 설정 (Configuration) ---
        // =================================================================
        const config = {
            IDLE_TIME: 10000,
            INPUT_MIN_WIDTH: 80,
            INPUT_WIDTH_BUFFER: 16,
            SOUND_THROTTLE_TIME: 50, // ms
            ROULETTE_CHANCE: 0.20, // 20%
        };

        const STAR_SVG_TEMPLATE = `<svg class="knowledge-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"/></svg>`;
        const SPARKLE_SVG_TEMPLATE = `<svg class="knowledge-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L9.5 9.5L2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5L12 2z"/></svg>`;
        // 전체 171개 문항 데이터는 data/quizzes.json에서 불러옵니다.
        let allQuizzes = [];
        
        
        const sounds = {
            coin: new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.2 },
                volume: -15
            }).toDestination(),
            click: new Tone.MembraneSynth({
                pitchDecay: 0.01,
                octaves: 2,
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 },
                volume: -25
            }).toDestination(),
            incorrect1: new Tone.MonoSynth({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.3 },
                filterEnvelope: { attack: 0.01, decay: 0.1, sustain: 0, baseFrequency: 800, octaves: -1.5 },
                volume: -15
            }).toDestination(),
            incorrect2: new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.15, sustain: 0 },
                volume: -18
            }).toDestination(),
            type: new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 },
                volume: -25
            }).toDestination(),
            perfect: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "pulse", width: 0.4 },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 },
                volume: -16
            }).toDestination(),
            rouletteClick: new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.2, release: 0.1 },
                harmonicity: 5,
                modulationIndex: 20,
                volume: -15
            }).toDestination(),
            win: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle8" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 },
                volume: -12
            }).toDestination(),
            jackpot: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'fatsawtooth', count: 5, spread: 40 },
                envelope: { attack: 0.01, decay: 1, sustain: 0.5, release: 1 },
                volume: -8
            }).toDestination()
        };

        // =================================================================
        // --- DOM 요소 (DOM Elements) ---
        // =================================================================
        let dom = {};

        // Canvas context for measuring text widths
        const textMeasureCanvas = document.createElement('canvas');
        const textMeasureCtx = textMeasureCanvas.getContext('2d');

        // =================================================================
        // --- 상태 (State) ---
        // =================================================================
        let state = {};

        function resetQuizState() {
             // 퀴즈 세션에만 해당하는 상태 초기화
            state.currentQuizIndex = 0;
            state.incorrectAttempts = {};
            state.isQuestionPerfect = true;
            state.questionPerfectStatus = {}; // 각 문제의 perfect 여부 기록
            state.activeQuizzes = [];
            state.selectedCategoryIndex = -1;
            state.moneyMultiplier = state.moneyMultiplier || 1;
            state.multiplierTurnsLeft = state.multiplierTurnsLeft || 0;
            state.initialQuizCount = 0;
            state.correctlyAnsweredCount = 0;
            state.countedCorrectQIDs = new Set();
            state.reviewScheduledQIDs = new Set();
        }

        function initializeGlobalState() {
            // 브라우저 세션 전체에 걸쳐 유지되는 상태
            state = {
                gameMode: 'sequential',
                money: 0, // 사이트 방문 시 자산 초기화
                completionStatus: {}, // 방문 시마다 진행 상태 초기화
                incorrectNotes: loadData('quizIncorrectNotes', []),
                currentExpression: 'normal',
                idleTimeout: null,
                lastTypeSoundTime: 0,
                activeInputValue: null,
                ...state // 기존 상태 유지
            };
            saveData('money', 0);
            localStorage.removeItem('quizProgress'); // 방문 시 진행 상태 초기화
            resetQuizState(); // 퀴즈 관련 상태는 초기화
        }


        // =================================================================
        // --- 데이터 관리 (Data Persistence) ---
        // =================================================================
        function loadData(key, defaultValue) {
            const savedData = localStorage.getItem(key);
            if (savedData === null) return defaultValue;
            try {
                return JSON.parse(savedData);
            } catch (e) {
                return defaultValue;
            }
        }

        function saveData(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }
        
        function addIncorrectNote(qid) {
            const incorrectNotes = loadData('quizIncorrectNotes', []);
            if (!incorrectNotes.includes(qid)) {
                incorrectNotes.push(qid);
                saveData('quizIncorrectNotes', incorrectNotes);
            }
        }

        function removeIncorrectNote(qid) {
            let incorrectNotes = loadData('quizIncorrectNotes', []);
            incorrectNotes = incorrectNotes.filter(id => id !== qid);
            saveData('quizIncorrectNotes', incorrectNotes);
        }

        function clearIncorrectNotes() {
            saveData('quizIncorrectNotes', []);
            renderIncorrectNoteList(); // UI 갱신
        }


        // =================================================================
        // --- 게임 로직 (Game Logic) ---
        // =================================================================

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function startQuiz(quizList, mode, categoryIndex = null) {
            if (Tone.context.state !== 'running') { await Tone.start(); }
            
            if (state.idleTimeout) clearTimeout(state.idleTimeout);

            resetQuizState();
            state.gameMode = mode;
            state.selectedCategoryIndex = categoryIndex;
            
            if (!quizList || quizList.length === 0) {
                showToast("풀어볼 문제가 없습니다!");
                return;
            }
            
            state.activeQuizzes = [...quizList];
            state.initialQuizCount = quizList.length;
            state.lastQuizList = [...quizList]; 

            if (state.gameMode === 'random' || state.gameMode === 'incorrect') {
                shuffleArray(state.activeQuizzes);
            }

            updateMoneyUI();
            
            dom.startScreen.classList.add('hidden');
            dom.incorrectNoteScreen.classList.add('hidden');
            dom.incorrectNoteScreen.classList.remove('flex');
            dom.endScreen.classList.add('hidden');
            dom.endScreen.classList.remove('flex');
            dom.gameUI.classList.remove('hidden');
            dom.quizBox.classList.remove('hidden');
            dom.nextBtn.classList.add('hidden');
            dom.totalQ.textContent = state.initialQuizCount;
            dom.currentQ.textContent = 0;
            
            setCharExpression('wave');
            renderQuestion();
        }
        
        function retryGame() {
            startQuiz(state.lastQuizList, state.gameMode, state.selectedCategoryIndex);
        }

        function returnToMainMenu() {
            if (state.idleTimeout) clearTimeout(state.idleTimeout);

            dom.gameUI.classList.add('hidden');
            dom.quizBox.classList.add('hidden');
            dom.endScreen.classList.remove('flex');
            dom.endScreen.classList.add('hidden');
            dom.incorrectNoteScreen.classList.remove('flex');
            dom.incorrectNoteScreen.classList.add('hidden');
            dom.step2ScopeSelection.classList.add('hidden');
            dom.step1ModeSelection.classList.remove('hidden');
            dom.startScreen.classList.remove('hidden');
            updateIncorrectNoteButton();
        }

        function nextQuestion() {
            state.currentQuizIndex++;
            if (state.currentQuizIndex < state.activeQuizzes.length) {
                dom.nextBtn.classList.add('hidden');
                dom.questionContainer.innerHTML = '';
                renderQuestion();
            } else {
                showGameOver();
            }
        }

        function showGameOver() {
            if (state.idleTimeout) clearTimeout(state.idleTimeout);

            if (state.gameMode === 'sequential' && state.selectedCategoryIndex !== null) {
                const numericIndex = parseInt(state.selectedCategoryIndex);
                const currentStatus = state.completionStatus[numericIndex] || 'unlocked';
                
                const allOriginalQuestions = state.lastQuizList;
                const allOriginalQIDs = new Set(allOriginalQuestions.map(q => q.qid));
                const allAnsweredCorrectly = [...allOriginalQIDs].every(qid => state.countedCorrectQIDs.has(qid));

                if (allAnsweredCorrectly) {
                     state.completionStatus[numericIndex] = 'perfect';
                } else if (currentStatus !== 'perfect') {
                    state.completionStatus[numericIndex] = 'completed';
                }
                saveData('quizProgress', state.completionStatus);
                renderKnowledgeMap();
            }
            
            dom.gameUI.classList.add('hidden');
            dom.quizBox.classList.add('hidden');
            dom.finalMoney.textContent = formatCurrency(state.money);
            
            dom.endScreen.classList.remove('hidden');
            dom.endScreen.classList.add('flex');
            
            setCharExpression('celebrate');
        }

        // =================================================================
        // --- UI 렌더링 (UI Rendering) ---
        // =================================================================

        function renderQuestion() {
            state.isQuestionPerfect = true;
            state.incorrectAttempts = {};
            setCharExpression('normal');
            
            const quiz = state.activeQuizzes[state.currentQuizIndex];
            let categoryText = quiz.detailedCategory;
            if (quiz.isReview) {
                categoryText = `<span class="text-red-400">[복습]</span> ${categoryText}`;
            }
            dom.categoryDisplay.innerHTML = categoryText;
            
            dom.questionContainer.classList.remove('text-3xl', 'sm:text-4xl', 'text-2xl', 'sm:text-3xl', 'text-xl', 'sm:text-2xl', 'text-lg', 'sm:text-xl');
            if (quiz.question.length > 200) { dom.questionContainer.classList.add('text-xl', 'sm:text-2xl'); }
            else if (quiz.question.length > 150) { dom.questionContainer.classList.add('text-2xl', 'sm:text-3xl'); }
            else { dom.questionContainer.classList.add('text-3xl', 'sm:text-4xl'); }

            dom.questionContainer.innerHTML = '';

            const parts = quiz.question.split(/(\{\d+\})/g).filter(p => p);
            
            parts.forEach(part => {
                const match = part.match(/\{(\d+)\}/);
                if (match) {
                    const index = parseInt(match[1]);
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-wrapper';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'quiz-input';
                    input.id = `input-${index}`;
                    input.dataset.answer = quiz.answers[index];
                    input.autocomplete = 'off';
                    input.spellcheck = false;
                    wrapper.appendChild(input);
                    dom.questionContainer.appendChild(wrapper);
                } else if (part.trim() !== '') {
                    const span = document.createElement('span');
                    span.textContent = part;
                    dom.questionContainer.appendChild(span);
                }
            });

            const inputs = dom.questionContainer.querySelectorAll('.quiz-input');
            inputs.forEach(input => {
                input.addEventListener('input', handleInput);
                input.addEventListener('keydown', handleEnterKey);
                input.addEventListener('focus', handleFocus);
                input.addEventListener('blur', handleBlur);
                updateInputWidth(input);
            });

            if (inputs.length > 0) { inputs[0].focus(); }
            resetIdleTimer();
            updateProgressUI();
        }
        
        // =================================================================
        // --- 입력 및 정답 처리 (Input & Answer Handling) ---
        // =================================================================
        
        function normalizeAnswer(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/\s|·|⋅|,/g, ''); // 공백, 쉼표, 모든 종류의 가운뎃점 제거
        }

        function handleInput(e) {
            clearTimeout(state.idleTimeout);
            const input = e.target;
            updateInputWidth(input);

            const normalizedAnswer = normalizeAnswer(input.dataset.answer);
            const normalizedValue = normalizeAnswer(input.value);

            if (normalizedAnswer.startsWith(normalizedValue)) {
                setCharExpression('happy');
                
                const now = performance.now();
                if (now - state.lastTypeSoundTime > config.SOUND_THROTTLE_TIME) {
                    sounds.type.triggerAttackRelease('C5', '32n', Tone.now());
                    state.lastTypeSoundTime = now;
                }
            } else {
                input.classList.add('wobble');
                setTimeout(() => input.classList.remove('wobble'), 300);
            }
            state.idleTimeout = setTimeout(() => setCharExpression('idle'), config.IDLE_TIME);
        }
        
        function checkAnswerOnSubmit(input) {
            if (input.disabled) return;
            resetIdleTimer();
            
            const answer = input.dataset.answer;
            const index = parseInt(input.id.split('-')[1]);
            const normalizedUserValue = normalizeAnswer(input.value);
            const normalizedAnswer = normalizeAnswer(answer);

            if (normalizedUserValue === normalizedAnswer) {
                 handleCorrectAnswer(input);
            } else {
                state.isQuestionPerfect = false;
                
                state.incorrectAttempts[index] = (state.incorrectAttempts[index] || 0) + 1;

                if (state.incorrectAttempts[index] === 1) {
                    setCharExpression('worried');
                    sounds.incorrect1.triggerAttackRelease('G2', '8n', Tone.now());
                    input.value = '';
                    updateInputWidth(input);
                    input.classList.add('incorrect-1', 'wobble');
                    setTimeout(() => input.classList.remove('wobble'), 300);
                } else {
                    setCharExpression('sad');
                    sounds.incorrect2.triggerAttackRelease('8n', Tone.now());
                    input.classList.remove('incorrect-1');
                    input.classList.add('incorrect-2');
                    input.value = answer;
                    updateInputWidth(input);
                    input.disabled = true;

                    focusNextInput(index);
                }
            }
        }
        
        function handleCorrectAnswer(input) {
            setCharExpression('happy');

            sounds.coin.triggerAttackRelease('B5', '16n', Tone.now());
            
            const index = parseInt(input.id.split('-')[1]);
            input.value = input.dataset.answer;
            updateInputWidth(input);
            input.classList.remove('incorrect-1', 'incorrect-2');
            input.classList.add('correct');
            input.disabled = true;

            if (!state.incorrectAttempts[index] || state.incorrectAttempts[index] < 2) {
                let earnings = Math.floor(Math.random() * 9001) + 1000; // 1,000 ~ 10,000
                if (state.multiplierTurnsLeft > 0) {
                    earnings *= state.moneyMultiplier;
                }
                
                state.money += earnings;
                saveData('money', state.money);
                showMoneyUpAnimation(input, `+${formatCurrency(earnings)}`);
                updateMoneyUI();
            } else {
                state.isQuestionPerfect = false;
            }

            const quiz = state.activeQuizzes[state.currentQuizIndex];
            if (state.gameMode === 'incorrect' && state.isQuestionPerfect) {
                 const allAnswered = Array.from(dom.questionContainer.querySelectorAll('.quiz-input')).every(i => i.classList.contains('correct'));
                if (allAnswered) {
                    removeIncorrectNote(quiz.qid);
                }
            }
            
            focusNextInput(index);
        }

        function checkAllAnswered() {
            const allDisabled = Array.from(dom.questionContainer.querySelectorAll('.quiz-input')).every(i => i.disabled);
            if (allDisabled) {
                const quiz = state.activeQuizzes[state.currentQuizIndex];
                
                const hasSecondWrong = Object.values(state.incorrectAttempts).some(v => v >= 2);

                if (state.isQuestionPerfect) {
                    state.questionPerfectStatus[state.currentQuizIndex] = true;
                    if (!state.countedCorrectQIDs.has(quiz.qid)) {
                        state.countedCorrectQIDs.add(quiz.qid);
                    }
                    state.correctlyAnsweredCount++;
                    updateProgressUI();
                    
                    const perfectNotes = ['C5', 'E5', 'G5', 'C6'];
                    sounds.perfect.triggerAttackRelease(perfectNotes, '8n', Tone.now());
                    showPerfectMessage();
                    triggerConfetti();
                    triggerScreenShake();

                    if (Math.random() < config.ROULETTE_CHANCE) {
                        setTimeout(showRoulette, 800);
                    } else {
                        setTimeout(() => {
                            dom.nextBtn.classList.remove('hidden');
                            dom.nextBtn.focus();
                        }, 800);
                    }
                } else if (hasSecondWrong) {
                    state.questionPerfectStatus[state.currentQuizIndex] = false;

                    const quiz = state.activeQuizzes[state.currentQuizIndex];
                    if (!quiz.isReview) {
                        addIncorrectNote(quiz.qid);
                    }

                    const reviewQuiz = { ...quiz, isReview: true };
                    state.activeQuizzes.splice(state.currentQuizIndex + 3, 0, reviewQuiz);

                    setTimeout(() => {
                        dom.nextBtn.classList.remove('hidden');
                        dom.nextBtn.focus();
                    }, 800);
                } else {
                    state.questionPerfectStatus[state.currentQuizIndex] = false;

                    setTimeout(() => {
                        dom.nextBtn.classList.remove('hidden');
                        dom.nextBtn.focus();
                    }, 800);
                }
            }
        }

        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                if (!dom.rouletteScreen.classList.contains('hidden') && !dom.spinBtn.disabled) {
                    spinRoulette();
                } else if (!dom.nextBtn.classList.contains('hidden')) {
                    nextQuestion();
                } else if (document.activeElement.classList.contains('quiz-input')) {
                    if (document.activeElement.value.trim() !== '') {
                        checkAnswerOnSubmit(document.activeElement);
                    }
                }
            }
        }

        function handleBlur(e) {
            const input = e.target;
            if (!input.disabled && input.value !== state.activeInputValue && input.value.trim() !== '') {
                checkAnswerOnSubmit(input);
            }
        }

        function handleFocus(e) { state.activeInputValue = e.target.value; }
        
        function focusNextInput(currentIndex) {
            const nextInput = document.getElementById(`input-${currentIndex + 1}`);
            if (nextInput && !nextInput.disabled) {
                nextInput.focus();
            } else {
                 const allInputs = Array.from(dom.questionContainer.querySelectorAll('.quiz-input'));
                 const nextAvailableInput = allInputs.find(i => !i.disabled);
                 if(nextAvailableInput) {
                        nextAvailableInput.focus();
                 } else {
                        checkAllAnswered();
                 }
            }
        }

        // =================================================================
        // --- UI 및 효과 (UI & Effects) ---
        // =================================================================
        function formatCurrency(num) {
            return new Intl.NumberFormat('ko-KR').format(num) + '원';
        }

        function updateMoneyUI() { 
            dom.money.textContent = formatCurrency(state.money); 
        }

        function updateProgressUI() {
            const progressPercent = state.initialQuizCount > 0 ? (state.countedCorrectQIDs.size / state.initialQuizCount) * 100 : 0;
            dom.progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
            dom.currentQ.textContent = state.correctlyAnsweredCount;
        }

        function updateInputWidth(input) {
            const computedStyle = window.getComputedStyle(input);
            textMeasureCtx.font = `${computedStyle.fontWeight} ${computedStyle.fontSize} ${computedStyle.fontFamily}`;
            const text = input.value || input.placeholder || " ";
            const textMetrics = textMeasureCtx.measureText(text);
            const availableWidth = dom.questionContainer.clientWidth;
            const desiredWidth = textMetrics.width + config.INPUT_WIDTH_BUFFER;
            const newWidth = Math.max(config.INPUT_MIN_WIDTH, Math.min(desiredWidth, availableWidth - 4));
            input.style.width = newWidth + 'px';
        }
        
        function showMoneyUpAnimation(target, text) {
            const el = document.createElement('div');
            el.className = 'score-up-animation text-yellow-400';
            el.textContent = text;
            const parentRect = dom.quizBox.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();
            el.style.left = `${targetRect.left - parentRect.left + targetRect.width / 2}px`;
            el.style.top = `${targetRect.top - parentRect.top}px`;
            dom.quizBox.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }


        function showPerfectMessage() {
            const perfectEl = document.createElement('div');
            perfectEl.textContent = "Perfect!";
            perfectEl.className = 'perfect-message';
            dom.quizBox.appendChild(perfectEl);
            setTimeout(() => {
                perfectEl.classList.add('fade-out');
                perfectEl.addEventListener('animationend', () => perfectEl.remove());
            }, 800);
        }

        function triggerConfetti() {
            for (let i = 0; i < 30; i++) {
                const c = document.createElement("div");
                c.className = "confetti";
                c.style.left = `${Math.random() * window.innerWidth}px`;
                c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                document.body.appendChild(c);
                c.animate([{ transform: "translateY(0)", opacity: 1 }, { transform: `translateY(${window.innerHeight}px)`, opacity: 0 }], { duration: 1000 + Math.random()*500, easing: "ease-out" }).onfinish = () => c.remove();
            }
        }

        function triggerScreenShake() {
            document.body.classList.add("shake");
            setTimeout(() => document.body.classList.remove("shake"), 500);
        }
        function showToast(message) {
            const toast = dom.reviewToast;
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 2000);
        }

        // =================================================================
        // --- 지도 & 오답노트 제어 (Map & Incorrect Note Control) ---
        // =================================================================
        function resetIdleTimer() {
            clearTimeout(state.idleTimeout);
            setCharExpression('normal');
            state.idleTimeout = setTimeout(() => setCharExpression('idle'), config.IDLE_TIME);
        }



let expressionTimeout;
function setCharExpression(type) {
    if (state.currentExpression === type && type !== 'wave' && type !== 'celebrate') return;
    state.currentExpression = type;

    clearTimeout(expressionTimeout);
    if (type === 'wave' || type === 'celebrate') {
        expressionTimeout = setTimeout(() => setCharExpression('idle'), 1500);
    }
}
        
        function populateCategoriesForRandomMode() {
            dom.categorySelect.innerHTML = ''; // Clear previous options

            const totalCount = allQuizzes.reduce((sum, cat) => sum + cat.questions.length, 0);
            const chongronCount = allQuizzes.filter(c => c.category.startsWith('총론')).reduce((sum, cat) => sum + cat.questions.length, 0);
            const changcheCount = allQuizzes.filter(c => c.category.startsWith('창의적 체험활동')).reduce((sum, cat) => sum + cat.questions.length, 0);

            const scopeOptions = [
                { value: 'all', text: `전범위 (${totalCount}개)` },
                { value: 'chongron', text: `총론 전체 (${chongronCount}개)` },
                { value: 'changche', text: `창의적 체험활동 전체 (${changcheCount}개)` }
            ];

            scopeOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                dom.categorySelect.appendChild(option);
            });

            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            dom.categorySelect.appendChild(separator);

            allQuizzes.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${cat.category.split(' | ')[1]} (${cat.questions.length}개)`;
                dom.categorySelect.appendChild(option);
            });
        }

        function renderKnowledgeMap() {
            dom.chongronMap.innerHTML = '';
            dom.changcheMap.innerHTML = '';

            allQuizzes.forEach((quizSet, index) => {
                const status = state.completionStatus[index] || 'unlocked';
                const iconContainer = document.createElement('div');
                iconContainer.className = 'star-container';
                
                const isChongron = quizSet.category.startsWith('총론');
                iconContainer.innerHTML = isChongron ? STAR_SVG_TEMPLATE : SPARKLE_SVG_TEMPLATE;
                iconContainer.querySelector('svg').classList.add(status);

                const label = document.createElement('div');
                label.className = 'star-label';
                const questionCount = quizSet.questions.length;
                label.textContent = `${quizSet.category.split(' | ')[1]} (${questionCount}개)`;

                iconContainer.appendChild(label);
                
                iconContainer.addEventListener('click', () => {
                    const questionsToLoad = allQuizzes[index].questions.map(q => ({ ...q, originalCategory: q.detailedCategory, originalIndex: index }));
                    startQuiz(questionsToLoad, 'sequential', index);
                });

                if (isChongron) {
                    dom.chongronMap.appendChild(iconContainer);
                } else {
                    dom.changcheMap.appendChild(iconContainer);
                }
            });
        }

        function renderIncorrectNoteList() {
            dom.incorrectListContainer.innerHTML = '';
            const incorrectQids = loadData('quizIncorrectNotes', []);
            if (incorrectQids.length === 0) {
                dom.incorrectListContainer.innerHTML = `<p class="text-gray-400">오답 기록이 없습니다. 완벽해요!</p>`;
                dom.startIncorrectQuizBtn.disabled = true;
                dom.clearIncorrectNotesBtn.disabled = true;
                return;
            }
            
            dom.startIncorrectQuizBtn.disabled = false;
            dom.clearIncorrectNotesBtn.disabled = false;
            
            const incorrectQuestions = [];
            allQuizzes.forEach(category => {
                category.questions.forEach(q => {
                    if(incorrectQids.includes(q.qid)) {
                        incorrectQuestions.push(q);
                    }
                })
            });

            incorrectQuestions.forEach(note => {
                const item = document.createElement('div');
                item.className = 'incorrect-item';
                
                const category = document.createElement('div');
                category.className = 'incorrect-item-category';
                category.textContent = note.detailedCategory;

                const question = document.createElement('div');
                question.className = 'incorrect-item-question';
                question.textContent = note.question.replace(/\{\d+\}/g, '___');

                item.appendChild(category);
                item.appendChild(question);
                dom.incorrectListContainer.appendChild(item);
            });
        }
        
        function updateIncorrectNoteButton() {
            const incorrectNotes = loadData('quizIncorrectNotes', []);
            dom.selectModeIncorrectBtn.disabled = incorrectNotes.length === 0;
            dom.selectModeIncorrectBtn.textContent = `오답노트 (${incorrectNotes.length})`;
        }

        // plant system removed

        // =================================================================
        // --- 룰렛 로직 (Roulette Logic) ---
        // =================================================================
        const rouletteItems = [
            { label: '+20,000', color: '#4CAF50', type: 'add', value: 20000, weight: 20 },
            { label: '꽝', color: '#757575', type: 'dud', value: 0, weight: 18 },
            { label: '+50,000', color: '#81C784', type: 'add', value: 50000, weight: 15 },
            { label: '-30,000', color: '#E57373', type: 'add', value: -30000, weight: 7 },
            { label: '자산 +20%', color: '#64B5F6', type: 'percent', value: 0.20, weight: 7 },
            { label: '자산 -20%', color: '#EF5350', type: 'percent', value: -0.20, weight: 7 },
            { label: '+150,000', color: '#AED581', type: 'add', value: 150000, weight: 4 },
            { label: '+200,000', color: '#C5E1A5', type: 'add', value: 200000, weight: 2 },
            { label: '2배 (3문제)', color: '#FFB74D', type: 'multiplier', value: 2, turns: 3, weight: 3 },
            { label: '자산 +50%', color: '#4FC3F7', type: 'percent', value: 0.50, weight: 3 },
            { label: '자산 +100%', color: '#FFD54F', type: 'percent', value: 1.00, weight: 2 },
            { label: 'JACKPOT!', color: '#FFEE58', type: 'add', value: 1000000, weight: 1 },
        ];
        let isSpinning = false;
        
        function setupSlotMachine() {
            const reel = dom.reels[0];
            if (!reel) return;
            const strip = reel.querySelector('.reel-strip');
            if (!strip) return;
            strip.innerHTML = '';
            const items = [...rouletteItems, ...rouletteItems, ...rouletteItems];

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'reel-item';
                itemEl.textContent = item.label;
                itemEl.style.backgroundColor = item.color;
                itemEl.dataset.label = item.label;
                strip.appendChild(itemEl);
            });
        }


        function spinRoulette() {
            if (isSpinning) return;
            isSpinning = true;
            dom.spinBtn.disabled = true;
            dom.spinBtn.classList.remove('can-spin');
            dom.rouletteResult.textContent = '';

            const totalWeight = rouletteItems.reduce((sum, item) => sum + item.weight, 0);
            let randomWeight = Math.random() * totalWeight;
            let resultItem;
            for (const item of rouletteItems) {
                randomWeight -= item.weight;
                if (randomWeight < 0) {
                    resultItem = item;
                    break;
                }
            }

            const reel = dom.reels[0];
            if (!reel) return;
            const strip = reel.querySelector('.reel-strip');
            if (!strip) return;

            strip.style.transition = 'none';
            strip.style.transform = 'translateY(0)';
            
            const resultIndex = rouletteItems.findIndex(item => item.label === resultItem.label);
            const targetIndex = rouletteItems.length + (resultIndex === -1 ? 0 : resultIndex);

            setTimeout(() => {
                const spinDuration = 1.0; // seconds
                strip.style.transition = `transform ${spinDuration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                const targetPosition = -targetIndex * 120;
                strip.style.transform = `translateY(${targetPosition}px)`;
            }, 100);

            const clickInterval = setInterval(() => {
                sounds.rouletteClick.triggerAttackRelease('8n', Tone.now());
            }, 50);

            setTimeout(() => {
                isSpinning = false;
                clearInterval(clickInterval);
                applyRouletteResult(resultItem, targetIndex);
                setTimeout(hideRoulette, 2000);
            }, 1100);
        }

        function applyRouletteResult(item, targetIndex) {
            let resultText = '';

            const strip = dom.reels[0].querySelector('.reel-strip');
            if (strip) {
                const actives = strip.querySelectorAll('.active');
                actives.forEach(el => el.classList.remove('active'));
                if (strip.children[targetIndex]) {
                    strip.children[targetIndex].classList.add('active');
                }
            }

            if (item.label === 'JACKPOT!') {
                showJackpotEffect();
                sounds.jackpot.triggerAttackRelease(['C4', 'E4', 'G4', 'C5', 'E5', 'G5', 'C6'], '1s', Tone.now());
            } else if ((item.type === 'add' && item.value > 0) || (item.type === 'percent' && item.value > 0) || item.type === 'multiplier') {
                 sounds.win.triggerAttackRelease(['C5', 'E5', 'G5'], '8n', Tone.now());
            } else {
                 sounds.incorrect1.triggerAttackRelease('G2', '8n', Tone.now());
            }
            
            switch(item.type) {
                case 'add':
                    state.money += item.value;
                    resultText = `${formatCurrency(item.value)} ${item.value >= 0 ? '획득!' : '잃음...'}`;
                    break;
                case 'percent':
                    const change = Math.floor(state.money * item.value);
                    state.money += change;
                    resultText = `자산 ${item.value > 0 ? '+' : ''}${item.value * 100}% (${formatCurrency(change)})`;
                    break;
                case 'multiplier':
                    state.moneyMultiplier = item.value;
                    state.multiplierTurnsLeft = item.turns;
                    resultText = `${item.turns}문제 동안 획득 자산 ${item.value}배!`;
                    break;
                case 'dud':
                    resultText = '아쉽지만... 꽝!';
                    break;
            }
            
            if (state.money < 0) state.money = 0;
            
            dom.rouletteResult.textContent = resultText;
            updateMoneyUI();
            saveData('money', state.money);
        }
        
        function showJackpotEffect() {
            const overlay = document.createElement('div');
            overlay.className = 'jackpot-overlay';
            const text = document.createElement('div');
            text.className = 'jackpot-text';
            text.textContent = 'JACKPOT!';
            overlay.appendChild(text);
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 2000);
        }

        function showRoulette() {
            dom.rouletteScreen.classList.remove('hidden');
            dom.rouletteScreen.classList.add('flex');
            setupSlotMachine();
            dom.spinBtn.disabled = false;
            dom.spinBtn.classList.add('can-spin');
        }

        function hideRoulette() {
            dom.rouletteScreen.classList.add('hidden');
            dom.rouletteScreen.classList.remove('flex');
            dom.nextBtn.classList.remove('hidden');
            dom.nextBtn.focus();
        }


        // --- 초기화 (Initialization) ---
        document.addEventListener('DOMContentLoaded', async () => {
            dom = {
                body: document.body,
                loadingScreen: document.getElementById('loading-screen'),
                gameUI: document.getElementById('game-ui'),
                money: document.getElementById('money'),
                progressBar: document.getElementById('progress-bar'),
                currentQ: document.getElementById('current-q'),
                totalQ: document.getElementById('total-q'),
                categoryDisplay: document.getElementById('category-display'),
                quizBox: document.getElementById('quiz-box'),
                questionContainer: document.getElementById('question-container'),
                nextBtn: document.getElementById('next-btn'),
                startScreen: document.getElementById('start-screen'),
                step1ModeSelection: document.getElementById('step-1-mode-selection'),
                step2ScopeSelection: document.getElementById('step-2-scope-selection'),
                selectModeSequentialBtn: document.getElementById('select-mode-sequential'),
                selectModeRandomBtn: document.getElementById('select-mode-random'),
                selectModeIncorrectBtn: document.getElementById('select-mode-incorrect'),
                backToModeSelectionBtn: document.getElementById('back-to-mode-selection'),
                sequentialModeUi: document.getElementById('sequential-mode-ui'),
                randomModeUi: document.getElementById('random-mode-ui'),
                startBtn: document.getElementById('start-btn'),
                categorySelect: document.getElementById('category-select'),
                chongronMap: document.getElementById('chongron-map'),
                changcheMap: document.getElementById('changche-map'),
                endScreen: document.getElementById('end-screen'),
                finalMoney: document.getElementById('final-money'),
                retryBtn: document.getElementById('retry-btn'),
                mainMenuBtn: document.getElementById('main-menu-btn'),
                homeBtn: document.getElementById('home-btn'),
                incorrectNoteScreen: document.getElementById('incorrect-note-screen'),
                backToMainFromIncorrectBtn: document.getElementById('back-to-main-from-incorrect'),
                incorrectListContainer: document.getElementById('incorrect-list-container'),
                startIncorrectQuizBtn: document.getElementById('start-incorrect-quiz-btn'),
                clearIncorrectNotesBtn: document.getElementById('clear-incorrect-notes-btn'),
                rouletteScreen: document.getElementById('roulette-screen'),
                slotMachine: document.getElementById('slot-machine'),
                reels: document.querySelectorAll('.reel'),
                rouletteResult: document.getElementById('roulette-result'),
                spinBtn: document.getElementById('spin-btn'),
                reviewToast: document.getElementById('review-toast'),
            };
            const response = await fetch("data/quizzes.json");
            allQuizzes = await response.json();

            initializeGlobalState();
            renderKnowledgeMap();
            updateIncorrectNoteButton();
            updateMoneyUI();
            
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                    }
                    sounds.click.triggerAttackRelease('C4', '32n', Tone.now());
                });
            });

            dom.selectModeSequentialBtn.addEventListener('click', () => {
                dom.step1ModeSelection.classList.add('hidden');
                dom.step2ScopeSelection.classList.remove('hidden');
                dom.sequentialModeUi.classList.remove('hidden');
                dom.randomModeUi.classList.add('hidden');
            });

            dom.selectModeRandomBtn.addEventListener('click', () => {
                populateCategoriesForRandomMode();
                dom.step1ModeSelection.classList.add('hidden');
                dom.step2ScopeSelection.classList.remove('hidden');
                dom.sequentialModeUi.classList.add('hidden');
                dom.randomModeUi.classList.remove('hidden');
            });

            dom.selectModeIncorrectBtn.addEventListener('click', () => {
                state.incorrectNotes = loadData('quizIncorrectNotes', []);
                renderIncorrectNoteList();
                dom.startScreen.classList.add('hidden');
                dom.incorrectNoteScreen.classList.remove('hidden');
                dom.incorrectNoteScreen.classList.add('flex');
            });

            dom.backToModeSelectionBtn.addEventListener('click', () => {
                dom.step2ScopeSelection.classList.add('hidden');
                dom.step1ModeSelection.classList.remove('hidden');
            });
            
            dom.backToMainFromIncorrectBtn.addEventListener('click', returnToMainMenu);

            dom.startBtn.addEventListener('click', () => {
                const selectedIndex = dom.categorySelect.value;
                let questionsToLoad = [];
                if (selectedIndex === 'all') {
                    questionsToLoad = allQuizzes.flatMap(cat => cat.questions.map(q => ({...q, originalCategory: q.detailedCategory})));
                } else if (selectedIndex === 'chongron') {
                    questionsToLoad = allQuizzes.filter(c => c.category.startsWith('총론')).flatMap(cat => cat.questions.map(q => ({...q, originalCategory: q.detailedCategory})));
                } else if (selectedIndex === 'changche') {
                    questionsToLoad = allQuizzes.filter(c => c.category.startsWith('창의적 체험활동')).flatMap(cat => cat.questions.map(q => ({...q, originalCategory: q.detailedCategory})));
                } else {
                    questionsToLoad = allQuizzes[selectedIndex].questions.map(q => ({...q, originalCategory: q.detailedCategory}));
                }
                startQuiz(questionsToLoad, 'random', selectedIndex);
            });

            dom.startIncorrectQuizBtn.addEventListener('click', () => {
                const incorrectQids = loadData('quizIncorrectNotes', []);
                if (incorrectQids.length === 0) {
                    showToast("오답 노트에 문항이 없습니다!");
                    return;
                }
                const questionsToReview = [];
                allQuizzes.forEach(category => {
                    category.questions.forEach(q => {
                        if(incorrectQids.includes(q.qid)) {
                            questionsToReview.push({ ...q, originalCategory: q.detailedCategory });
                        }
                    });
                });
                startQuiz(questionsToReview, 'incorrect');
            });

            dom.clearIncorrectNotesBtn.addEventListener('click', () => {
                clearIncorrectNotes();
                updateIncorrectNoteButton();
            });

            dom.retryBtn.addEventListener('click', retryGame);
            dom.mainMenuBtn.addEventListener('click', returnToMainMenu);
            dom.homeBtn.addEventListener('click', returnToMainMenu);
            dom.nextBtn.addEventListener('click', nextQuestion);
            dom.spinBtn.addEventListener('click', spinRoulette);
            
            document.addEventListener('keydown', handleEnterKey);

            dom.loadingScreen.classList.add('hidden');
        });
    </script>
</body>
</html>
